<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Portugu√™s - SAEB 2025 üìù</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;500;600;700&family=Roboto+Condensed:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --neon-pink: #FF0080;
            --neon-purple: #B000FF;
            --neon-cyan: #00E5FF;
            --neon-yellow: #FFD700;
            --dark-bg: #0A0A0A;
            --darker-bg: #050505;
            --card-bg: #151515;
            --text-primary: #FFFFFF;
            --text-secondary: #CCCCCC;
            --correct-green: #00FF7F;
            --error-red: #FF3333;
            --gradient-main: linear-gradient(135deg, #FF0080, #B000FF, #00E5FF);
            --gradient-secondary: linear-gradient(45deg, #FFD700, #FF0080);
        }

        body {
            font-family: 'Roboto Condensed', sans-serif;
            background: var(--dark-bg);
            color: var(--text-primary);
            line-height: 1.5;
            overflow-x: hidden;
            min-height: 100vh;
        }

        .bg-grid {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(255, 0, 128, 0.08) 1px, transparent 1px),
                        linear-gradient(90deg, rgba(255, 0, 128, 0.08) 1px, transparent 1px);
            background-size: 50px 50px; z-index: 1; pointer-events: none;
            animation: gridMove 20s linear infinite;
        }
        @keyframes gridMove { 0% { transform: translate(0,0); } 100% { transform: translate(50px,50px); } }

        .neon-particles { position: fixed; inset: 0; pointer-events: none; z-index: 2; }
        .particle { position: absolute; width: 4px; height: 4px; background: var(--neon-pink); border-radius: 50%; box-shadow: 0 0 10px var(--neon-pink); animation: particleFloat 8s infinite ease-in-out; }
        @keyframes particleFloat { 0%,100%{ transform: translateY(100vh); opacity:0 } 10%,90%{ opacity:1 } 50%{ transform: translateY(-10vh) } }

        header { position: fixed; top: 0; width: 100%; background: rgba(10,10,10,0.9); backdrop-filter: blur(16px); border-bottom: 2px solid var(--neon-pink); z-index: 1000; }
        .header-content { max-width: 1200px; margin: 0 auto; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; gap: 1rem; }
        .logo { font-family: 'Oswald', sans-serif; font-size: clamp(1.4rem, 4vw, 2rem); font-weight: 900; background: var(--gradient-main); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: 2px; cursor: pointer; }
        .quiz-info { display: flex; align-items: center; gap: 1rem; color: var(--text-secondary); font-size: clamp(0.9rem,2vw,1rem); }
        .question-counter { background: var(--gradient-secondary); color: #000; padding: 0.4rem 1rem; border-radius: 999px; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; }
        .score { color: var(--neon-cyan); font-weight: 900; }

        .quiz-container { margin-top: 110px; min-height: calc(100vh - 110px); position: relative; z-index: 10; }
        .question-container { max-width: 900px; margin: 0 auto; padding: 1.5rem; display: flex; flex-direction: column; min-height: calc(100vh - 160px); }
        .question-card { background: var(--card-bg); border: 2px solid var(--neon-cyan); border-radius: 20px; padding: clamp(1.5rem,4vw,2.5rem); margin-bottom: 1.5rem; position: relative; overflow: hidden; box-shadow: 0 0 40px rgba(0,229,255,0.25); }
        .question-card::before { content: ''; position: absolute; inset: 0; background: var(--gradient-main); opacity: .05; }
        .question-number { position: absolute; top: -10px; right: 18px; background: var(--gradient-main); color: #000; padding: .4rem 1rem; border-radius: 0 0 14px 14px; font-family: 'Oswald', sans-serif; font-weight: 900; letter-spacing: 1px; font-size: .9rem; }
        .question-text { font-size: clamp(1.05rem, 3vw, 1.35rem); color: var(--text-primary); }
        .question-text strong { color: var(--neon-yellow); }

        .alternatives-container { display: flex; flex-direction: column; gap: .9rem; margin: 1.2rem 0 2rem; }
        .alternative { background: var(--darker-bg); border: 2px solid transparent; border-radius: 14px; padding: clamp(1rem,3vw,1.2rem); display: flex; gap: 1rem; align-items: center; cursor: pointer; transition: all .25s cubic-bezier(.175,.885,.32,1.275); position: relative; overflow: hidden; }
        .alternative::before { content: ''; position: absolute; inset: 0; background: var(--gradient-main); opacity: 0; transition: opacity .25s; }
        .alternative:hover { border-color: var(--neon-purple); transform: translateX(8px); box-shadow: 0 6px 20px rgba(176,0,255,.25); }
        .alternative:hover::before { opacity: .08; }
        .alternative.selected { border-color: var(--neon-cyan); background: rgba(0,229,255,.08); transform: translateX(8px); }
        .alternative.correct { border-color: var(--correct-green); background: rgba(0,255,127,.12); animation: correctPulse 1s ease-out; }
        .alternative.incorrect { border-color: var(--error-red); background: rgba(255,51,51,.12); animation: incorrectShake .5s ease-out; }
        @keyframes correctPulse { 0%{ transform: scale(1) } 50%{ transform: scale(1.02) } 100%{ transform: scale(1) } }
        @keyframes incorrectShake { 0%,100%{ transform: translateX(0) } 25%{ transform: translateX(-5px) } 75%{ transform: translateX(5px) } }
        .alternative-letter { background: var(--gradient-main); color: #000; width: 40px; height: 40px; border-radius: 50%; display: grid; place-items: center; font-family: 'Oswald', sans-serif; font-weight: 900; flex-shrink: 0; }
        .alternative-text { font-size: clamp(.95rem,2.5vw,1.05rem); }

        .quiz-actions { margin-top: auto; display: flex; justify-content: center; gap: 1rem; padding-top: 1.5rem; }
        .action-btn { background: var(--gradient-main); color: #000; padding: clamp(1rem,3vw,1.2rem) clamp(2rem,4vw,3rem); border: none; border-radius: 999px; font-family: 'Oswald', sans-serif; font-size: clamp(1rem, 2.5vw, 1.15rem); font-weight: 900; letter-spacing: 1px; cursor: pointer; transition: all .25s; box-shadow: 0 6px 24px rgba(176,0,255,.35); position: relative; overflow: hidden; }
        .action-btn:hover { transform: translateY(-3px) scale(1.04); box-shadow: 0 12px 30px rgba(176,0,255,.45); }
        .action-btn:disabled { opacity: .55; cursor: not-allowed; box-shadow: none; transform: none; }
        .action-btn::before { content: ''; position: absolute; inset: 0; left: -100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,.35), transparent); transition: left .6s; }
        .action-btn:hover::before { left: 100%; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.85); backdrop-filter: blur(10px); z-index: 10000; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: all .25s; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .feedback-modal { background: var(--card-bg); border: 3px solid var(--neon-purple); border-radius: 24px; padding: clamp(1.8rem,5vw,2.6rem); width: min(720px, 92vw); max-height: 90vh; overflow-y: auto; text-align: center; box-shadow: 0 0 50px rgba(176,0,255,.5); }
        .feedback-modal.error { border-color: var(--error-red); box-shadow: 0 0 50px rgba(255,51,51,.4); }
        .feedback-title { font-family: 'Oswald', sans-serif; font-size: clamp(1.6rem,4vw,2.1rem); font-weight: 900; text-transform: uppercase; color: var(--neon-purple); margin-bottom: 1rem; }
        .feedback-title.error { color: var(--error-red); }
        .feedback-character { width: clamp(140px, 28vw, 200px); height: clamp(140px, 28vw, 200px); border-radius: 18px; margin: 0 auto 1.2rem; border: 3px solid var(--neon-purple); object-fit: cover; box-shadow: 0 0 30px rgba(176,0,255,.35); }
        .feedback-character.error { border-color: var(--error-red); box-shadow: 0 0 30px rgba(255,51,51,.35); }
        .speech-bubble { background: var(--darker-bg); border: 2px solid var(--neon-yellow); border-radius: 18px; padding: 1rem 1.2rem; margin: 1rem 0; }
        .correct-answer { color: var(--text-primary); font-size: clamp(1rem,2.5vw,1.15rem); margin-bottom: .5rem; }
        .explanation { color: var(--text-secondary); font-style: italic; font-size: clamp(.9rem,2.2vw,1rem); }
        .continue-btn { background: var(--gradient-secondary); color: #000; padding: .9rem 2rem; border: none; border-radius: 16px; font-family: 'Oswald', sans-serif; font-weight: 900; letter-spacing: 1px; cursor: pointer; transition: transform .2s; margin-top: 1.2rem; }
        .continue-btn:hover { transform: translateY(-2px) scale(1.03); }

        .results-container { max-width: 820px; margin: 0 auto; padding: 1.5rem; text-align: center; }
        .results-card { background: var(--card-bg); border: 3px solid var(--neon-purple); border-radius: 24px; padding: clamp(2rem,6vw,3rem); position: relative; overflow: hidden; box-shadow: 0 0 45px rgba(176,0,255,.3); }
        .results-card::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: conic-gradient(var(--neon-purple) 0deg, var(--neon-pink) 90deg, var(--neon-cyan) 180deg, var(--neon-yellow) 270deg, var(--neon-purple) 360deg); opacity: .06; animation: rotate 8s linear infinite; }
        @keyframes rotate { from { transform: rotate(0) } to { transform: rotate(360deg) } }
        .results-title { font-family: 'Oswald', sans-serif; font-size: clamp(2rem,6vw,3.2rem); font-weight: 900; text-transform: uppercase; background: var(--gradient-main); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 1.5rem; }
        .score-display { font-family: 'Oswald', sans-serif; font-size: clamp(3rem, 8vw, 5rem); color: var(--neon-cyan); text-shadow: 0 0 28px var(--neon-cyan); margin: 1.5rem 0; }
        .performance-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); gap: 1.2rem; margin: 2rem 0; }
        .stat-item { background: var(--darker-bg); border: 2px solid var(--neon-pink); border-radius: 16px; padding: 1.4rem; }
        .stat-label { font-size: .9rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: .4rem; }
        .stat-value { font-family: 'Oswald', sans-serif; font-size: clamp(1.4rem, 4vw, 2rem); font-weight: 900; color: var(--neon-yellow); }
        .improvement-areas { background: var(--darker-bg); border: 2px solid var(--neon-cyan); border-radius: 18px; padding: 1.4rem; margin: 1.5rem 0; text-align: left; }
        .improvement-title { font-family: 'Oswald', sans-serif; color: var(--neon-cyan); font-size: clamp(1.2rem,3vw,1.5rem); font-weight: 900; text-transform: uppercase; text-align: center; margin-bottom: .8rem; }
        .improvement-list { list-style: none; padding: 0; }
        .improvement-list li { padding: .45rem 0 .45rem 2rem; color: var(--text-secondary); position: relative; }
        .improvement-list li::before { content: 'üìñ'; position: absolute; left: 0; top: .4rem; }
        .lobby-btn { background: var(--gradient-main); color: #000; padding: 1.1rem 2.6rem; border: none; border-radius: 999px; font-family: 'Oswald', sans-serif; font-weight: 900; letter-spacing: 1px; cursor: pointer; box-shadow: 0 6px 28px rgba(176,0,255,.35); transition: transform .2s; margin-top: 1rem; }
        .lobby-btn:hover { transform: translateY(-3px) scale(1.04); }

        .hidden { display: none !important; }

        @media (max-width: 768px) {
            .header-content { flex-direction: column; text-align: center; }
            .quiz-info { flex-direction: column; gap: .6rem; }
            .quiz-container { margin-top: 150px; }
            .question-container { padding: 1rem; min-height: calc(100vh - 200px); }
            .alternative:hover { transform: translateX(5px); }
            .alternative.selected { transform: translateX(5px); }
        }
        @media (max-width: 480px) {
            .quiz-container { margin-top: 170px; }
            .feedback-character { width: 120px; height: 120px; }
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--darker-bg); }
        ::-webkit-scrollbar-thumb { background: var(--gradient-main); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--neon-purple); }
    </style>
</head>
<body>
    <div class="bg-grid"></div>
    <div class="neon-particles" id="particles"></div>

    <header>
        <div class="header-content">
            <div class="logo" onclick="goToLobby()">üìù QUIZ PORTUGU√äS</div>
            <div class="quiz-info">
                <div class="question-counter" id="questionCounter">QUEST√ÉO 1/10</div>
                <div class="score" id="scoreDisplay">ACERTOS: 0</div>
            </div>
        </div>
    </header>

    <div class="quiz-container">
        <div id="questionScreen" class="question-container">
            <div class="question-card">
                <div class="question-number" id="questionNumber">QUEST√ÉO 1</div>
                <div class="question-text" id="questionText">Carregando pergunta...</div>
            </div>

            <div class="alternatives-container" id="alternativesContainer"></div>

            <div class="quiz-actions">
                <button class="action-btn" id="confirmBtn" onclick="confirmAnswer()" disabled>üìù CONFIRMAR RESPOSTA</button>
            </div>
        </div>

        <div id="resultsScreen" class="results-container hidden">
            <div class="results-card">
                <h1 class="results-title">RESULTADO FINAL</h1>
                <div class="score-display" id="finalScore">0/10</div>
                <div class="performance-stats">
                    <div class="stat-item">
                        <div class="stat-label">üìä APROVEITAMENTO</div>
                        <div class="stat-value" id="percentageScore">0%</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">‚úÖ ACERTOS</div>
                        <div class="stat-value" id="correctAnswers">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">‚ùå ERROS</div>
                        <div class="stat-value" id="incorrectAnswers">0</div>
                    </div>
                </div>

                <div class="improvement-areas">
                    <h3 class="improvement-title">üìö √ÅREAS PARA MELHORAR</h3>
                    <ul class="improvement-list" id="improvementList"></ul>
                </div>

                <button class="lobby-btn" onclick="returnToLobby()">üè† VOLTAR PARA O LOBBY</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="feedbackModal">
        <div class="feedback-modal" id="feedbackContent"></div>
    </div>

    <script>
        // Banco de quest√µes (25+ quest√µes do SAEB - preservadas/adaptadas)
        const questions = [
            { question: "No texto 'Eu te amo n√£o diz tudo!', a express√£o 'tempestade em copo d'√°gua' significa:", alternatives: ["alerta", "ilus√£o", "exagero", "deboche", "tamanho"], correct: 2, explanation: "Expressa exagero diante de algo pequeno." },
            { question: "O trecho 'O cara diz que te ama, ent√£o t√°!' mostra linguagem:", alternatives: ["formal", "t√©cnica", "regional", "coloquial", "jornal√≠stica"], correct: 3, explanation: "Vocabul√°rio e estrutura informais caracterizam linguagem coloquial." },
            { question: "A finalidade do texto 'Eu te amo n√£o diz tudo!' √©:", alternatives: ["descrever sentimentos", "enfatizar atitudes", "valorizar dizer 'eu te amo'", "incentivar reconcilia√ß√£o", "definir tipos de amor"], correct: 1, explanation: "Enfatiza atitudes como prova concreta de amor." },
            { question: "Segundo o texto, o que mais demonstra amor √©:", alternatives: ["presentes caros", "surpresas", "dizer 'eu te amo'", "interesse real", "declara√ß√µes em redes"], correct: 3, explanation: "Interesse real e a√ß√µes consistentes demonstram amor." },
            { question: "A palavra 'candidez' no poema significa:", alternatives: ["pureza", "leveza", "beleza", "sutileza", "grandeza"], correct: 0, explanation: "Candidez = pureza, inoc√™ncia." },
            { question: "A locu√ß√£o 'Al√©m disso' introduz:", alternatives: ["√™nfase", "contraposi√ß√£o", "exemplo", "consequ√™ncia", "informa√ß√£o complementar"], correct: 4, explanation: "Adiciona informa√ß√£o que complementa a anterior." },
            { question: "O humor em 'Vendo o saldo do banco depois de pagar as contas' √© gerado por:", alternatives: ["express√£o do rosto", "palavra 'contas'", "rela√ß√£o verbal e n√£o verbal", "contradi√ß√£o", "ideia de jovens sem contas"], correct: 2, explanation: "Surge da rela√ß√£o entre texto e imagem facial (linguagem mista)." },
            { question: "O travess√£o em 'O dr. Argemiro, advogado, ‚Äî dos mais distintos...' serve para:", alternatives: ["indicar fala", "iniciar fala", "separar termo", "acrescentar informa√ß√£o", "isolar palavra"], correct: 3, explanation: "Aposto explicativo inserido por travess√£o." },
            { question: "No texto 'O volunt√°rio', o elemento predominante √©:", alternatives: ["descri√ß√£o da personagem", "ambienta√ß√£o", "tempo", "desfecho", "cl√≠max"], correct: 0, explanation: "Predomina a caracteriza√ß√£o da personagem." },
            { question: "Para Godard, 'cultura' tem car√°ter:", alternatives: ["sem arte", "conservador", "disputa ideol√≥gica", "transgressivo", "engloba linguagens"], correct: 3, explanation: "Cultura vista como transgressiva e provocativa." },
            { question: "O efeito de humor da tirinha √© causado por:", alternatives: ["susto do pai", "TV quebrada", "martelo", "surpresa da m√£e", "duplo sentido da fala"], correct: 4, explanation: "Duplo sentido gera o humor da situa√ß√£o." },
            { question: "O tema do texto do DETRAN √©:", alternatives: ["boas decis√µes", "seguran√ßa", "√°lcool e dire√ß√£o", "consumo de √°lcool", "semana de seguran√ßa"], correct: 2, explanation: "Foco na rela√ß√£o perigosa entre √°lcool e dire√ß√£o." },
            { question: "O travess√£o pode ser usado para:", alternatives: ["mudan√ßa de fala", "iniciar fala", "separar termos", "acrescentar informa√ß√£o", "todas as anteriores"], correct: 4, explanation: "Tem m√∫ltiplas fun√ß√µes: di√°logo/aposto/etc." },
            { question: "Tema do texto 'R√°dio Senado come√ßa a operar em Teresina':",
              alternatives: ["Teresina", "programa√ß√£o da r√°dio", "chegada da R√°dio Senado a Teresina", "expans√£o", "parceria"], correct: 2, explanation: "In√≠cio das opera√ß√µes em Teresina." },
            { question: "Informa√ß√£o principal sobre enciclop√©dia:", alternatives: ["uso em bibliotecas", "obsoleta como pesquisa", "h√°bito antigo", "primeira em 1772", "internet facilitou"], correct: 1, explanation: "Se tornou obsoleta para pesquisa." },
            { question: "Nos textos sobre envelhecimento, apresentam:", alternatives: ["fim da vida", "desvalorizado", "fraqueza", "diferentes perspectivas", "impede mudan√ßas"], correct: 3, explanation: "Perspectivas variadas sobre o tema." },
            { question: "Finalidade de textos de divulga√ß√£o cient√≠fica:", alternatives: ["informar", "vender", "emocionar", "divertir", "instruir"], correct: 0, explanation: "Objetivo principal √© informar." },
            { question: "Finalidade de uma campanha contra dengue:", alternatives: ["divulgar", "convidar", "vender", "instruir", "divertir"], correct: 3, explanation: "Instruir sobre preven√ß√£o e combate." },
            { question: "Dois textos sobre Aedes aegypti s√£o:", alternatives: ["contr√°rios", "diferentes", "divergentes", "antag√¥nicos", "semelhantes"], correct: 4, explanation: "Tratam do mesmo tema de forma semelhante." },
            { question: "Interlocutor ideal de um manual de iPhone:", alternatives: ["novos usu√°rios", "desenvolvedores", "t√©cnicos", "usu√°rios avan√ßados", "engenheiros"], correct: 0, explanation: "Material voltado a iniciantes no produto." },
            { question: "Em doa√ß√£o de √≥rg√£os, 'interessado' refere-se a:", alternatives: ["paciente", "cad√°ver", "corpo", "doador", "receptor"], correct: 3, explanation: "Refere-se ao doador (quem manifesta interesse)." },
            { question: "Quando o autor descreve espa√ßo e tempo, usa:", alternatives: ["descri√ß√£o", "ambienta√ß√£o", "narra√ß√£o", "disserta√ß√£o", "cl√≠max"], correct: 1, explanation: "Ambienta√ß√£o localiza a hist√≥ria." },
            { question: "'Antigamente' remete a:", alternatives: ["presente", "passado", "compara√ß√£o", "futuro", "contradi√ß√£o"], correct: 1, explanation: "Adv√©rbio de tempo passado." },
            { question: "Linguagem usada em charges costuma ser:", alternatives: ["t√©cnica", "cient√≠fica", "humor√≠stica", "acad√™mica", "jornal√≠stica"], correct: 2, explanation: "Humor √© tra√ßo marcante em charges." },
            { question: "Em 'Ele estudou muito, por√©m n√£o passou', 'por√©m' indica:", alternatives: ["adi√ß√£o", "explica√ß√£o", "conclus√£o", "oposi√ß√£o", "condi√ß√£o"], correct: 3, explanation: "Conjun√ß√£o adversativa (oposi√ß√£o)." },
            { question: "G√™nero textual 'receita culin√°ria' caracteriza-se por:", alternatives: ["narrar", "descrever", "instruir procedimentos", "argumentar", "relatar"], correct: 2, explanation: "√â predominantemente instrucional." }
        ];

        const errorCharacters = [
            "https://i.ibb.co/Qj73wn6/IMG-4292.png",
            "https://i.ibb.co/kg63TCn/IMG-4287.png",
            "https://i.ibb.co/XkJ1Y9q/IMG-4285.png",
            "https://i.ibb.co/Wp7smTf/IMG-4283.png"
        ];

        // Estado
        let currentQuestionIndex = 0;
        let selectedQuestions = [];
        let score = 0;
        let selectedAnswer = null;
        let startTime = Date.now();
        let answered = false;

        // Persist√™ncia compartilhada com homepage (estat√≠sticas)
        function loadStats() {
            try { const raw = localStorage.getItem('saebStats'); return raw ? JSON.parse(raw) : {}; } catch(e){ return {}; }
        }
        function saveStats(stats) { try { localStorage.setItem('saebStats', JSON.stringify(stats)); } catch(e){} }
        function updateStatsAfterQuiz(finalCorrect, totalQuestions, elapsedMinutes) {
            const stats = loadStats();
            stats.quizzesCompleted = (stats.quizzesCompleted || 0) + 1;
            stats.totalMinutes = (stats.totalMinutes || 0) + (elapsedMinutes || 0);
            stats.overallCorrect = (stats.overallCorrect || 0) + finalCorrect;
            stats.overallTotal = (stats.overallTotal || 0) + totalQuestions;
            stats.portCorrect = (stats.portCorrect || 0) + finalCorrect;
            stats.portTotal = (stats.portTotal || 0) + totalQuestions;

            const passed = finalCorrect >= Math.ceil(totalQuestions * 0.7);
            stats.currentStreak = passed ? (stats.currentStreak || 0) + 1 : 0;
            stats.bestStreak = Math.max(stats.bestStreak || 0, stats.currentStreak);

            const overallPct = Math.round((stats.overallCorrect || 0) / Math.max(1, (stats.overallTotal || 0)) * 100);
            if (overallPct >= 90) stats.ranking = 'Lend√°rio';
            else if (overallPct >= 75) stats.ranking = 'Pro';
            else if (overallPct >= 50) stats.ranking = 'Intermedi√°rio';
            else stats.ranking = 'Iniciante';

            saveStats(stats);
        }

        function goToLobby() { window.location.href = '/index.html#lobby'; }

        function initQuiz() {
            selectedQuestions = getRandomQuestions(questions, 10);
            currentQuestionIndex = 0; score = 0; selectedAnswer = null; startTime = Date.now(); answered = false;
            createParticles();
            showQuestion();
        }

        function getRandomQuestions(arr, count) { const shuffled = [...arr].sort(() => 0.5 - Math.random()); return shuffled.slice(0, count); }

        function createParticles() {
            const container = document.getElementById('particles');
            container.innerHTML = '';
            for (let i = 0; i < 20; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.left = Math.random() * 100 + '%';
                p.style.animationDelay = Math.random() * 8 + 's';
                p.style.animationDuration = (8 + Math.random() * 4) + 's';
                container.appendChild(p);
            }
        }

        function showQuestion() {
            if (currentQuestionIndex >= selectedQuestions.length) { showResults(); return; }
            const q = selectedQuestions[currentQuestionIndex];
            answered = false;
            document.getElementById('questionCounter').textContent = `QUEST√ÉO ${currentQuestionIndex + 1}/10`;
            document.getElementById('scoreDisplay').textContent = `ACERTOS: ${score}`;
            document.getElementById('questionNumber').textContent = `QUEST√ÉO ${currentQuestionIndex + 1}`;
            document.getElementById('questionText').textContent = q.question;
            const container = document.getElementById('alternativesContainer');
            container.innerHTML = '';
            q.alternatives.forEach((alt, idx) => {
                const div = document.createElement('div');
                div.className = 'alternative';
                div.onclick = () => selectAnswer(idx);
                div.innerHTML = `<div class="alternative-letter">${String.fromCharCode(65 + idx)}</div><div class="alternative-text">${alt}</div>`;
                container.appendChild(div);
            });
            selectedAnswer = null;
            const btn = document.getElementById('confirmBtn');
            btn.disabled = true;
            btn.textContent = 'üìù CONFIRMAR RESPOSTA';
        }

        function selectAnswer(index) {
            if (answered) return;
            document.querySelectorAll('.alternative').forEach(a => a.classList.remove('selected'));
            const target = document.querySelectorAll('.alternative')[index];
            if (target) target.classList.add('selected');
            selectedAnswer = index;
            document.getElementById('confirmBtn').disabled = false;
        }

        function confirmAnswer() {
            if (selectedAnswer === null || answered) return;
            answered = true;
            const q = selectedQuestions[currentQuestionIndex];
            const isCorrect = selectedAnswer === q.correct;
            document.getElementById('confirmBtn').disabled = true;
            document.querySelectorAll('.alternative').forEach((alt, idx) => {
                alt.onclick = null;
                if (idx === q.correct) alt.classList.add('correct');
                else if (idx === selectedAnswer && !isCorrect) alt.classList.add('incorrect');
            });
            if (isCorrect) { score++; document.getElementById('scoreDisplay').textContent = `ACERTOS: ${score}`; }
            setTimeout(() => showFeedbackModal(isCorrect, q), 900);
        }

        function showFeedbackModal(isCorrect, q) {
            const modal = document.getElementById('feedbackModal');
            const content = document.getElementById('feedbackContent');
            if (isCorrect) {
                content.className = 'feedback-modal';
                content.innerHTML = `
                    <div class="feedback-title">PARAB√âNS!</div>
                    <div style="font-size:4rem;margin:1rem 0;">üéâ</div>
                    <div class="correct-answer">Resposta correta!</div>
                    <div class="explanation">${q.explanation}</div>
                    <button class="continue-btn" onclick="nextQuestion()">CONTINUAR</button>
                `;
            } else {
                const img = errorCharacters[Math.floor(Math.random() * errorCharacters.length)];
                const correctLetter = String.fromCharCode(65 + q.correct);
                content.className = 'feedback-modal error';
                content.innerHTML = `
                    <div class="feedback-title error">RESPOSTA INCORRETA</div>
                    <img src="${img}" alt="Personagem" class="feedback-character error" onerror="this.style.display='none'" />
                    <div class="speech-bubble">
                        <div class="correct-answer">A resposta correta √© a alternativa <strong>${correctLetter}</strong>.</div>
                        <div class="explanation">${q.explanation}</div>
                    </div>
                    <button class="continue-btn" onclick="nextQuestion()">CONTINUAR</button>
                `;
            }
            modal.classList.add('active');
        }

        function nextQuestion() {
            document.getElementById('feedbackModal').classList.remove('active');
            currentQuestionIndex++;
            if (currentQuestionIndex < selectedQuestions.length) {
                setTimeout(() => {
                    document.querySelectorAll('.alternative').forEach(alt => alt.classList.remove('correct','incorrect','selected'));
                    showQuestion();
                }, 250);
            } else {
                setTimeout(showResults, 250);
            }
        }

        function showResults() {
            document.getElementById('questionScreen').classList.add('hidden');
            document.getElementById('resultsScreen').classList.remove('hidden');
            const elapsed = Math.floor((Date.now() - startTime) / 60000);
            const pct = Math.round((score / selectedQuestions.length) * 100);
            document.getElementById('finalScore').textContent = `${score}/${selectedQuestions.length}`;
            document.getElementById('percentageScore').textContent = `${pct}%`;
            document.getElementById('correctAnswers').textContent = score;
            document.getElementById('incorrectAnswers').textContent = selectedQuestions.length - score;

            // Persistir resultados compat√≠veis com homepage
            updateStatsAfterQuiz(score, selectedQuestions.length, elapsed);

            const list = document.getElementById('improvementList');
            list.innerHTML = '';
            if (pct < 50) {
                list.innerHTML = `
                    <li>Revisar conceitos b√°sicos de interpreta√ß√£o de texto</li>
                    <li>Praticar leitura de diferentes g√™neros</li>
                    <li>Estudar figuras de linguagem</li>
                    <li>Resolver mais exerc√≠cios de compreens√£o</li>
                `;
            } else if (pct < 70) {
                list.innerHTML = `
                    <li>Aprimorar an√°lise lingu√≠stica e coes√£o</li>
                    <li>Estudar fun√ß√µes da linguagem</li>
                    <li>Treinar conectivos e rela√ß√µes l√≥gicas</li>
                `;
            } else if (pct < 90) {
                list.innerHTML = `
                    <li>Focar em quest√µes mais complexas</li>
                    <li>Analisar textos multimodais</li>
                    <li>Praticar intertextualidade</li>
                `;
            } else {
                list.innerHTML = `
                    <li>Excelente desempenho em L√≠ngua Portuguesa!</li>
                    <li>Continue praticando para manter o n√≠vel</li>
                    <li>Explore an√°lises liter√°rias mais profundas</li>
                `;
            }
        }

        function returnToLobby() {
            if (confirm('Deseja realmente reiniciar o quiz?')) {
                // Voltar para o lobby da raiz
                goToLobby();
            }
        }

        document.getElementById('feedbackModal').onclick = function(e) { if (e.target === this) { /* n√£o fecha */ } };
        document.addEventListener('touchstart', function(e){ if (e.touches.length > 1) e.preventDefault(); }, { passive: false });
        window.addEventListener('error', e => console.error('Erro no quiz:', e));
        window.addEventListener('load', initQuiz);
    </script>
</body>
</html>
